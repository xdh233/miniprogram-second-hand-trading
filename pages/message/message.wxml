<!-- pages/message/message.wxml -->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-section">
    <view class="search-box">
      <icon class="search-icon" type="search" size="16" />
      <input 
        placeholder="æœç´¢è”ç³»äººæˆ–æ¶ˆæ¯å†…å®¹..." 
        bindinput="onSearchInput"
        value="{{searchKeyword}}"
      />
      <view class="clear-btn" wx:if="{{searchKeyword}}" bindtap="clearSearch">
        <icon type="cancel" size="14" />
      </view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ†ç±»æ ‡ç­¾ -->
  <view class="message-tabs">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="0">
      <text>å…¨éƒ¨æ¶ˆæ¯</text>
      <view class="tab-badge" wx:if="{{totalUnread > 0}}">{{totalUnread}}</view>
    </view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="1">
      <text>äº¤æ˜“æ¶ˆæ¯</text>
      <view class="tab-badge" wx:if="{{tradeUnread > 0}}">{{tradeUnread}}</view>
    </view>
    <view class="tab-item {{currentTab === 2 ? 'active' : ''}}" bindtap="switchTab" data-index="2">
      <text>ç³»ç»Ÿé€šçŸ¥</text>
      <view class="tab-badge" wx:if="{{systemUnread > 0}}">{{systemUnread}}</view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <view class="message-list" wx:if="{{filteredMessages.length > 0}}">
    <view class="message-item" 
          wx:for="{{filteredMessages}}" 
          wx:key="id" 
          bindtap="openChat" 
          data-chat-id="{{item.chatId}}"
          data-user-id="{{item.userId}}">
      
      <!-- å·¦æ»‘åˆ é™¤ -->
      <movable-area class="movable-area">
        <movable-view class="movable-view" direction="horizontal" x="{{item.offsetX || 0}}">
          <view class="message-content">
            <!-- ç”¨æˆ·å¤´åƒ -->
            <view class="avatar-section">
              <image class="user-avatar" src="{{item.avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
              <view class="online-status {{item.isOnline ? 'online' : 'offline'}}"></view>
              <view class="unread-badge" wx:if="{{item.unreadCount > 0}}">{{item.unreadCount > 99 ? '99+' : item.unreadCount}}</view>
            </view>

            <!-- æ¶ˆæ¯ä¿¡æ¯ -->
            <view class="message-info">
              <view class="message-header">
                <view class="user-name">{{item.userName}}</view>
                <view class="message-time">{{item.lastMessageTime}}</view>
              </view>
              
              <view class="message-preview">
                <view class="message-text">{{item.lastMessage}}</view>
                <view class="message-type" wx:if="{{item.messageType === 'image'}}">
                  <icon type="success_circle" size="12" />
                  <text>[å›¾ç‰‡]</text>
                </view>
                <view class="message-type" wx:if="{{item.messageType === 'item'}}">
                  <icon type="success_circle" size="12" />
                  <text>[å•†å“]</text>
                </view>
              </view>

              <!-- å•†å“ä¿¡æ¯ -->
              <view class="related-item" wx:if="{{item.relatedItem}}">
                <image class="item-image" src="{{item.relatedItem.image}}" mode="aspectFill" />
                <view class="item-info">
                  <view class="item-title">{{item.relatedItem.title}}</view>
                  <view class="item-price">Â¥{{item.relatedItem.price}}</view>
                </view>
              </view>
            </view>

            <!-- æ¶ˆæ¯çŠ¶æ€ -->
            <view class="message-status">
              <view class="status-indicator {{item.status}}" wx:if="{{item.status}}"></view>
              <view class="message-actions">
                <icon type="success_no_circle" size="16" color="#ccc" />
              </view>
            </view>
          </view>
        </movable-view>
        
        <!-- åˆ é™¤æŒ‰é’® -->
        <view class="delete-btn" bindtap="deleteMessage" data-id="{{item.id}}" catchtap="">
          <icon type="cancel" size="20" color="white" />
          <text>åˆ é™¤</text>
        </view>
      </movable-area>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{filteredMessages.length === 0 && !loading}}">
    <view class="empty-icon">ğŸ’¬</view>
    <view class="empty-text">
      {{searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¶ˆæ¯' : (currentTab === 0 ? 'æš‚æ— æ¶ˆæ¯' : (currentTab === 1 ? 'æš‚æ— äº¤æ˜“æ¶ˆæ¯' : 'æš‚æ— ç³»ç»Ÿé€šçŸ¥'))}}
    </view>
    <view class="empty-desc" wx:if="{{!searchKeyword && currentTab === 0}}">
      å»å¸‚åœºé€›é€›ï¼Œæ‰¾äº›æ„Ÿå…´è¶£çš„å•†å“å§
    </view>
    <button class="go-market-btn" wx:if="{{!searchKeyword && currentTab === 0}}" bindtap="goToMarket">
      å»é€›é€›
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- ä¸‹æ‹‰åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore && !loading}}" bindtap="loadMore">
    <view class="load-more-text">ç‚¹å‡»åŠ è½½æ›´å¤š</view>
  </view>

  <!-- åº•éƒ¨å ä½ -->
  <view class="bottom-space"></view>
</view>

<!-- æ“ä½œèœå• -->
<view class="action-sheet" wx:if="{{showActionSheet}}" bindtap="hideActionSheet">
  <view class="action-content" catchtap="">
    <view class="action-title">é€‰æ‹©æ“ä½œ</view>
    <view class="action-list">
      <view class="action-item" bindtap="markAsRead">æ ‡è®°ä¸ºå·²è¯»</view>
      <view class="action-item" bindtap="pinChat">{{selectedMessage.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶ä¼šè¯'}}</view>
      <view class="action-item" bindtap="muteChat">{{selectedMessage.isMuted ? 'å–æ¶ˆå…æ‰“æ‰°' : 'æ¶ˆæ¯å…æ‰“æ‰°'}}</view>
      <view class="action-item danger" bindtap="deleteChat">åˆ é™¤ä¼šè¯</view>
    </view>
    <view class="action-cancel" bindtap="hideActionSheet">å–æ¶ˆ</view>
  </view>
</view>