<!-- pages/chat/chat.wxml -->
<view class="container">
  <!-- å•†å“ä¿¡æ¯å¡ç‰‡ -->
  <view class="item-card" wx:if="{{relatedItem}}" bindtap="goToItemDetail">
    <image class="item-image" src="{{relatedItem.image}}" mode="aspectFill" />
    <view class="item-info">
      <view class="item-title">{{relatedItem.title}}</view>
      <view class="item-price">Â¥{{relatedItem.price}}</view>
      <view class="item-status">{{relatedItem.status === 'active' ? 'åœ¨å”®ä¸­' : 'å·²ä¸‹æ¶'}}</view>
    </view>
    <view class="item-arrow">></view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    bindscrolltoupper="loadMoreMessages"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
  >
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="load-more-tip" wx:if="{{loadingMore}}">
      <view class="loading-spinner"></view>
      <text>åŠ è½½æ›´å¤šæ¶ˆæ¯...</text>
    </view>

    <!-- æ¶ˆæ¯é¡¹ -->
    <view class="message-item {{message.type}}" 
          wx:for="{{messages}}" 
          wx:key="id" 
          id="msg_{{message.id}}">
      
      <!-- æ—¶é—´åˆ†å‰²çº¿ -->
      <view class="time-divider" wx:if="{{message.showTime}}">
        <text>{{message.timeText}}</text>
      </view>

      <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
      <view class="system-message" wx:if="{{message.type === 'system'}}">
        <text>{{message.content}}</text>
      </view>

      <!-- æ™®é€šæ¶ˆæ¯ -->
      <view class="chat-message {{message.isSelf ? 'self' : 'other'}}" wx:else>
        <!-- å¯¹æ–¹å¤´åƒ -->
        <image class="message-avatar" 
               wx:if="{{!message.isSelf}}" 
               src="{{chatUser.avatar || '/images/default-avatar.png'}}" 
               mode="aspectFill" />

        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content">
          <!-- æ–‡æœ¬æ¶ˆæ¯ -->
          <view class="text-message" wx:if="{{message.type === 'text'}}">
            {{message.content}}
          </view>

          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="image-message" wx:elif="{{message.type === 'image'}}">
            <image class="message-image" 
                   src="{{message.imageUrl}}" 
                   mode="aspectFit"
                   bindtap="previewImage"
                   data-src="{{message.imageUrl}}" />
          </view>

          <!-- å•†å“åˆ†äº«æ¶ˆæ¯ -->
          <view class="item-message" wx:elif="{{message.type === 'item'}}" bindtap="goToSharedItem" data-item="{{message.itemData}}">
            <view class="shared-item">
              <image class="shared-image" src="{{message.itemData.image}}" mode="aspectFill" />
              <view class="shared-info">
                <view class="shared-title">{{message.itemData.title}}</view>
                <view class="shared-price">Â¥{{message.itemData.price}}</view>
                <view class="shared-desc">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</view>
              </view>
            </view>
          </view>

          <!-- æ¶ˆæ¯çŠ¶æ€ -->
          <view class="message-status" wx:if="{{message.isSelf}}">
            <view class="status-text" wx:if="{{message.status === 'sending'}}">å‘é€ä¸­</view>
            <view class="status-text" wx:elif="{{message.status === 'failed'}}">å‘é€å¤±è´¥</view>
            <icon class="status-icon" wx:elif="{{message.status === 'sent'}}" type="success_no_circle" size="14" />
            <icon class="status-icon read" wx:elif="{{message.status === 'read'}}" type="success" size="14" />
          </view>
        </view>

        <!-- è‡ªå·±çš„å¤´åƒ -->
        <image class="message-avatar" 
               wx:if="{{message.isSelf}}" 
               src="{{currentUser.avatar || '/images/default-avatar.png'}}" 
               mode="aspectFill" />
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ï¼Œç¡®ä¿æœ€æ–°æ¶ˆæ¯å¯è§ -->
    <view class="message-bottom" id="message_bottom"></view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-section">
    <!-- å¿«æ·åŠŸèƒ½ -->
    <view class="quick-actions" wx:if="{{showQuickActions}}">
      <view class="quick-item" bindtap="sendImageMessage">
        <view class="quick-icon">ğŸ“·</view>
        <view class="quick-text">å›¾ç‰‡</view>
      </view>
      <view class="quick-item" bindtap="shareItem">
        <view class="quick-icon">ğŸ“¦</view>
        <view class="quick-text">å•†å“</view>
      </view>
      <view class="quick-item" bindtap="sendLocation">
        <view class="quick-icon">ğŸ“</view>
        <view class="quick-text">ä½ç½®</view>
      </view>
      <view class="quick-item" bindtap="sendContact">
        <view class="quick-icon">ğŸ‘¤</view>
        <view class="quick-text">è”ç³»æ–¹å¼</view>
      </view>
    </view>

    <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
    <view class="input-bar">
      <view class="input-left">
        <view class="action-btn" bindtap="toggleQuickActions">
          <icon type="plus" size="20" color="{{showQuickActions ? '#667eea' : '#999'}}" />
        </view>
      </view>

      <view class="input-center">
        <textarea 
          class="message-input"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          value="{{inputText}}"
          bindinput="onInputChange"
          bindconfirm="sendTextMessage"
          auto-height
          show-confirm-bar="{{false}}"
          cursor-spacing="10"
          maxlength="500"
        />
      </view>

      <view class="input-right">
        <view class="action-btn" wx:if="{{!inputText.trim()}}" bindtap="sendVoiceMessage">
          <icon type="success_circle" size="20" color="#999" />
        </view>
        <view class="send-btn {{inputText.trim() ? 'active' : ''}}" 
              wx:else 
              bindtap="sendTextMessage">
          å‘é€
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å•†å“é€‰æ‹©å¼¹çª— -->
<view class="modal-mask" wx:if="{{showItemModal}}" bindtap="hideItemModal">
  <view class="modal-content item-modal" catchtap="">
    <view class="modal-title">é€‰æ‹©è¦åˆ†äº«çš„å•†å“</view>
    
    <scroll-view class="item-list" scroll-y>
      <view class="selectable-item" 
            wx:for="{{myItems}}" 
            wx:key="id"
            bindtap="selectItem"
            data-item="{{item}}">
        <image class="select-item-image" src="{{item.images[0]}}" mode="aspectFill" />
        <view class="select-item-info">
          <view class="select-item-title">{{item.title}}</view>
          <view class="select-item-price">Â¥{{item.price}}</view>
          <view class="select-item-status">{{item.status === 'active' ? 'åœ¨å”®' : 'å·²ä¸‹æ¶'}}</view>
        </view>
        <view class="select-arrow">></view>
      </view>
    </scroll-view>

    <view class="modal-actions">
      <button class="modal-btn cancel-btn" bindtap="hideItemModal">å–æ¶ˆ</button>
    </view>
  </view>
</view>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<view class="image-preview" wx:if="{{showImagePreview}}" bindtap="hideImagePreview">
  <image class="preview-image" src="{{previewImageUrl}}" mode="aspectFit" />
  <view class="preview-close" bindtap="hideImagePreview">
    <icon type="cancel" size="20" color="white" />
  </view>
</view>

<!-- è¯­éŸ³å½•åˆ¶ç•Œé¢ -->
<view class="voice-record" wx:if="{{recording}}">
  <view class="record-content">
    <view class="record-icon">ğŸ¤</view>
    <view class="record-text">æ­£åœ¨å½•éŸ³...</view>
    <view class="record-time">{{recordTime}}s</view>
    <view class="record-tip">æ¾å¼€å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ</view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½èŠå¤©è®°å½•...</view>
  </view>
</view>