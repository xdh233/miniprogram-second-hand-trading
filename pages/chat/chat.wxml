<view class="chat-container">
  <!-- 自定义导航栏 -->
  <!-- <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;"> -->
  <view class="custom-nav">
    <view class="nav-left" bindtap="onBackTap">
      <text class="back-icon">‹</text>
    </view>
    <view class="nav-center">
      <text class="nav-title">{{otherUser.nickname}}</text>
      <text class="nav-subtitle" wx:if="{{otherUser.isOnline}}">在线</text>
    </view>
    <view class="nav-right">
      <text class="nav-more">⋯</text>
    </view>
  </view>

  <!-- 内容容器 - 模仿消息页面结构 -->
  <!-- <view class="content-container" style="padding-top: {{navBarHeight}}px;"> -->
  <view class="content-container">
  
    <!-- 商品卡片 - 不再fixed，使用普通流布局 -->
    <view class="item-card-fixed" wx:if="{{showItemCard && relatedItem}}" 
          data-item="{{relatedItem}}" bindtap="onItemCardTap">
      <image class="item-image" src="{{relatedItem.images[0]}}" mode="aspectFill"/>
      <view class="item-info">
        <text class="item-title">{{relatedItem.title}}</text>
        <text class="item-price">￥{{relatedItem.price}}</text>
      </view>
    </view>

    <!-- 消息列表 - 使用flex布局，不再fixed -->
    <scroll-view 
      class="messages-scroll"
      scroll-y
      scroll-top="{{scrollTop}}"
      bindscrolltoupper="onScrollToUpper"
      enable-back-to-top
    >
      <!-- 加载更多提示 -->
      <view class="load-more" wx:if="{{loading}}">
        <text>加载中...</text>
      </view>

      <!-- 消息列表 -->
      <view class="message-item {{item.isSelf ? 'self' : 'other'}}" 
            wx:for="{{messages}}" 
            wx:key="id"
            data-id="{{item.id}}"
            bindlongpress="onLongPressMessage">
        
        <!-- 时间显示 -->
        <view class="message-time" wx:if="{{item.showTime}}">
          <text>{{item.timeDisplay}}</text>
        </view>

        <view class="message-content">
          <!-- 头像 -->
          <image class="message-avatar" 
                 src="{{item.isSelf ? userInfo.avatar : otherUser.avatar}}" 
                 mode="aspectFill"/>
          
          <!-- 消息气泡 -->
          <view class="message-bubble {{item.type}}">
            <!-- 文本消息 -->
            <text wx:if="{{item.type === 'text'}}" class="message-text">{{item.content}}</text>
            
            <!-- 图片消息 -->
            <image wx:elif="{{item.type === 'image'}}" 
                   class="message-image" 
                   src="{{item.imageUrl}}" 
                   mode="aspectFill"
                   data-url="{{item.imageUrl}}"
                   bindtap="previewImage"/>
            
            <!-- 商品消息 -->
            <view wx:elif="{{item.type === 'item'}}" class="message-item-card"
                  data-item="{{item.itemData}}" bindtap="onItemCardTap">
              <image class="item-card-image" src="{{item.itemData.image}}" mode="aspectFill"/>
              <view class="item-card-info">
                <text class="item-card-title">{{item.itemData.title}}</text>
                <text class="item-card-price">￥{{item.itemData.price}}</text>
              </view>
            </view>
            
            <!-- 系统消息 -->
            <text wx:elif="{{item.type === 'system'}}" class="system-message">{{item.content}}</text>
          </view>
        </view>
      </view>

      <!-- 空消息提示 -->
      <view class="empty-messages" wx:if="{{messages.length === 0 && !loading}}">
        <text>暂无消息，开始聊天吧~</text>
      </view>

      <!-- 底部占位 -->
      <view class="bottom-placeholder"></view>
    </scroll-view>
  </view>

  <!-- 输入栏 - 保持fixed -->
  <view class="input-bar" style="bottom: {{inputBottom}}px">
    <view class="input-container">
      <!-- 附加功能按钮 -->
      <view class="input-extra">
        <text class="extra-btn" bindtap="sendImageMessage">📷</text>
        <text class="extra-btn" wx:if="{{relatedItem}}" bindtap="sendItemMessage">🏷️</text>
      </view>
      
      <!-- 文本输入框 -->
      <input class="text-input"
             placeholder="输入消息..."
             placeholder-class="input-placeholder"
             value="{{inputText}}"
             bindinput="onInputChange"
             bindconfirm="sendTextMessage"
             adjust-position="{{false}}"
             bindkeyboardheightchange="onKeyboardHeightChange"
             confirm-type="send"/>
      
      <!-- 发送按钮 -->
      <view class="send-btn {{inputText ? 'active' : ''}}" 
            bindtap="sendTextMessage">
        <text>发送</text>
      </view>
    </view>
  </view>
</view>