<view class="chat-container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <!-- <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;"> -->
  <view class="custom-nav">
    <view class="nav-left" bindtap="onBackTap">
      <text class="back-icon">â€¹</text>
    </view>
    <view class="nav-center">
      <text class="nav-title">{{otherUser.nickname}}</text>
      <text class="nav-subtitle" wx:if="{{otherUser.isOnline}}">åœ¨çº¿</text>
    </view>
    <view class="nav-right">
      <text class="nav-more">â‹¯</text>
    </view>
  </view>

  <!-- å†…å®¹å®¹å™¨ - æ¨¡ä»¿æ¶ˆæ¯é¡µé¢ç»“æ„ -->
  <!-- <view class="content-container" style="padding-top: {{navBarHeight}}px;"> -->
  <view class="content-container">
  
    <!-- å•†å“å¡ç‰‡ - ä¸å†fixedï¼Œä½¿ç”¨æ™®é€šæµå¸ƒå±€ -->
    <view class="item-card-fixed" wx:if="{{showItemCard && relatedItem}}" 
          data-item="{{relatedItem}}" bindtap="onItemCardTap">
      <image class="item-image" src="{{relatedItem.images[0]}}" mode="aspectFill"/>
      <view class="item-info">
        <text class="item-title">{{relatedItem.title}}</text>
        <text class="item-price">ï¿¥{{relatedItem.price}}</text>
      </view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ - ä½¿ç”¨flexå¸ƒå±€ï¼Œä¸å†fixed -->
    <scroll-view 
      class="messages-scroll"
      scroll-y
      scroll-top="{{scrollTop}}"
      bindscrolltoupper="onScrollToUpper"
      enable-back-to-top
    >
      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <view class="load-more" wx:if="{{loading}}">
        <text>åŠ è½½ä¸­...</text>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view class="message-item {{item.isSelf ? 'self' : 'other'}}" 
            wx:for="{{messages}}" 
            wx:key="id"
            data-id="{{item.id}}"
            bindlongpress="onLongPressMessage">
        
        <!-- æ—¶é—´æ˜¾ç¤º -->
        <view class="message-time" wx:if="{{item.showTime}}">
          <text>{{item.timeDisplay}}</text>
        </view>

        <view class="message-content">
          <!-- å¤´åƒ -->
          <image class="message-avatar" 
                 src="{{item.isSelf ? userInfo.avatar : otherUser.avatar}}" 
                 mode="aspectFill"/>
          
          <!-- æ¶ˆæ¯æ°”æ³¡ -->
          <view class="message-bubble {{item.type}}">
            <!-- æ–‡æœ¬æ¶ˆæ¯ -->
            <text wx:if="{{item.type === 'text'}}" class="message-text">{{item.content}}</text>
            
            <!-- å›¾ç‰‡æ¶ˆæ¯ -->
            <image wx:elif="{{item.type === 'image'}}" 
                   class="message-image" 
                   src="{{item.imageUrl}}" 
                   mode="aspectFill"
                   data-url="{{item.imageUrl}}"
                   bindtap="previewImage"/>
            
            <!-- å•†å“æ¶ˆæ¯ -->
            <view wx:elif="{{item.type === 'item'}}" class="message-item-card"
                  data-item="{{item.itemData}}" bindtap="onItemCardTap">
              <image class="item-card-image" src="{{item.itemData.image}}" mode="aspectFill"/>
              <view class="item-card-info">
                <text class="item-card-title">{{item.itemData.title}}</text>
                <text class="item-card-price">ï¿¥{{item.itemData.price}}</text>
              </view>
            </view>
            
            <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
            <text wx:elif="{{item.type === 'system'}}" class="system-message">{{item.content}}</text>
          </view>
        </view>
      </view>

      <!-- ç©ºæ¶ˆæ¯æç¤º -->
      <view class="empty-messages" wx:if="{{messages.length === 0 && !loading}}">
        <text>æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§~</text>
      </view>

      <!-- åº•éƒ¨å ä½ -->
      <view class="bottom-placeholder"></view>
    </scroll-view>
  </view>

  <!-- è¾“å…¥æ  - ä¿æŒfixed -->
  <view class="input-bar" style="bottom: {{inputBottom}}px">
    <view class="input-container">
      <!-- é™„åŠ åŠŸèƒ½æŒ‰é’® -->
      <view class="input-extra">
        <text class="extra-btn" bindtap="sendImageMessage">ğŸ“·</text>
        <text class="extra-btn" wx:if="{{relatedItem}}" bindtap="sendItemMessage">ğŸ·ï¸</text>
      </view>
      
      <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
      <input class="text-input"
             placeholder="è¾“å…¥æ¶ˆæ¯..."
             placeholder-class="input-placeholder"
             value="{{inputText}}"
             bindinput="onInputChange"
             bindconfirm="sendTextMessage"
             adjust-position="{{false}}"
             bindkeyboardheightchange="onKeyboardHeightChange"
             confirm-type="send"/>
      
      <!-- å‘é€æŒ‰é’® -->
      <view class="send-btn {{inputText ? 'active' : ''}}" 
            bindtap="sendTextMessage">
        <text>å‘é€</text>
      </view>
    </view>
  </view>
</view>