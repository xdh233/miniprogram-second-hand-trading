<view class="container">
  <!-- å•†å“ä¿¡æ¯å¡ç‰‡ -->
  <view class="item-card" wx:if="{{relatedItem}}" bindtap="goToItemDetail">
    <image class="item-image" src="{{relatedItem.image}}" mode="aspectFill" />
    <view class="item-info">
      <view class="item-title">{{relatedItem.title}}</view>
      <view class="item-price">Â¥{{relatedItem.price}}</view>
    </view>
    <view class="item-arrow">></view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    bindscrolltoupper="loadMoreMessages"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
  >
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="loading-more" wx:if="{{loadingMore}}">
      <view class="loading-dot"></view>
      <text>åŠ è½½æ›´å¤š...</text>
    </view>

    <!-- æ¶ˆæ¯å†…å®¹ -->
    <block wx:for="{{messages}}" wx:key="id">
      <!-- æ—¶é—´åˆ†å‰²çº¿ -->
      <view class="time-divider" wx:if="{{item.showTime}}">
        <text>{{item.timeText}}</text>
      </view>

      <!-- æ¶ˆæ¯é¡¹ -->
      <view class="chat-message {{item.isSelf ? 'self' : ''}}">
        <image 
          class="message-avatar" 
          src="{{item.isSelf ? currentUser.avatar : chatUser.avatar}}" 
          mode="aspectFill"
        />
        
        <!-- æ–‡æœ¬æ¶ˆæ¯ -->
        <view class="message-content" wx:if="{{item.type === 'text'}}">
          <view class="text-message">{{item.content}}</view>
        </view>
        
        <!-- å›¾ç‰‡æ¶ˆæ¯ -->
        <view class="message-content" wx:elif="{{item.type === 'image'}}">
          <image 
            class="image-message" 
            src="{{item.imageUrl}}" 
            mode="widthFix" 
            bindtap="previewImage"
            data-src="{{item.imageUrl}}"
          />
        </view>

        <!-- å•†å“æ¶ˆæ¯ -->
        <view class="message-content" wx:elif="{{item.type === 'item'}}">
          <view class="shared-item" bindtap="goToItemDetail" data-id="{{item.itemData.id}}">
            <image class="shared-image" src="{{item.itemData.image}}" mode="aspectFill"/>
            <view class="shared-info">
              <view class="shared-title">{{item.itemData.title}}</view>
              <view class="shared-price">Â¥{{item.itemData.price}}</view>
            </view>
          </view>
        </view>
      </view>
    </block>

    <!-- åº•éƒ¨ç•™ç™½ï¼Œç”¨äºæ–°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ»šåŠ¨ -->
    <view id="message_bottom" style="height: 20rpx;"></view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-section">
    <view class="input-bar">
      <view class="input-left">
        <button class="action-btn" bindtap="toggleQuickActions">+</button>
      </view>
      <view class="input-center">
        <input 
          class="message-input"
          type="text"
          value="{{inputText}}"
          bindinput="onInputChange"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          confirm-type="send"
          bindconfirm="sendTextMessage"
        />
      </view>
      <view class="input-right">
        <button 
          class="send-btn {{inputText.trim() ? 'active' : ''}}" 
          bindtap="sendTextMessage"
        >å‘é€</button>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œé¢æ¿ -->
    <view class="quick-actions" wx:if="{{showQuickActions}}">
      <view class="quick-item" bindtap="sendImageMessage">
        <view class="quick-icon">ğŸ–¼ï¸</view>
        <view class="quick-text">å›¾ç‰‡</view>
      </view>
      <view class="quick-item" bindtap="shareItem">
        <view class="quick-icon">ğŸ“¦</view>
        <view class="quick-text">å•†å“</view>
      </view>
    </view>
  </view>
</view>

<!-- å•†å“é€‰æ‹©å¼¹çª— -->
<view class="modal-mask" wx:if="{{showItemModal}}" bindtap="hideItemModal">
  <view class="modal-content item-modal" catchtap="stopEvent">
    <view class="modal-title">é€‰æ‹©è¦åˆ†äº«çš„å•†å“</view>
    <scroll-view class="item-list" scroll-y>
      <view 
        class="selectable-item"
        wx:for="{{myItems}}"
        wx:key="id"
        bindtap="selectItem"
        data-item="{{item}}"
      >
        <image class="item-image" src="{{item.image}}" mode="aspectFill"/>
        <view class="item-info">
          <view class="item-title">{{item.title}}</view>
          <view class="item-price">Â¥{{item.price}}</view>
        </view>
      </view>
    </scroll-view>
    <view class="modal-actions">
      <button class="modal-btn cancel-btn" bindtap="hideItemModal">å–æ¶ˆ</button>
    </view>
  </view>
</view>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<view class="image-preview" wx:if="{{showImagePreview}}" bindtap="hideImagePreview">
  <image class="preview-image" src="{{previewImageUrl}}" mode="aspectFit"/>
  <view class="preview-close">âœ•</view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>