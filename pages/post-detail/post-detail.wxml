<!--pages/post-detail/post-detail.wxml-->
<view class="page-container">
  
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 帖子详情 -->
  <view wx:else class="content-scroll" scroll-y="{{true}}" enhanced="{{true}}">
    
    <!-- 主帖内容卡片 -->
    <view wx:if="{{post}}" class="post-card">
      
      <!-- 用户信息区域 -->
      <view class="user-section">
        <image class="user-avatar" src="{{post.userAvatar}}" mode="aspectFill" />
        <view class="user-info">
          <text class="username">{{post.userNickname}}</text>
          <text class="post-time">{{post.timeAgo}}</text>
        </view>
        <button class="chat-btn" bindtap="onPrivateChat">私信</button>
      </view>

      <!-- 帖子正文内容 -->
      <view class="post-content">
        <text class="content-text">{{post.content}}</text>
      </view>

      <!-- 图片展示区域 -->
      <view wx:if="{{post.images && post.images.length > 0}}" class="images-section">
        <!-- 单图：保持原始比例 -->
        <view class="single-image" wx:if="{{post.images.length === 1}}">
          <image 
            class="post-image-single" 
            src="{{post.images[0]}}" 
            mode="widthFix"
            data-images="{{post.images}}"
            data-index="0"
            bindtap="previewImageFixed"
          />
        </view>
        <!-- 多图：智能网格布局 -->
        <view class="images-grid images-grid-{{post.images.length}}" wx:else>
          <view 
            class="grid-item"
            wx:for="{{post.images}}" 
            wx:for-item="img"
            wx:for-index="imgIndex"
            wx:key="imgIndex"
          >
            <image 
              class="grid-image" 
              src="{{img}}" 
              mode="aspectFill"
              data-images="{{post.images}}"
              data-index="{{imgIndex}}"
              bindtap="previewImageFixed"
            />
          </view>
        </view>
      </view>
    
      <!-- 点赞和评论按钮 -->
      <view class="action-buttons">
        <button class="action-btn share-btn" open-type="share">
          <image class="action-icon" src="/images/forward.png" mode="aspectFit" />
          <text class="action-text">分享</text>
        </button>

        <view class="action-btn comment-btn">
          <image class="action-icon" src="/images/comment.png" mode="aspectFit" />
          <text class="action-count">{{post.comments || 0}}</text>
        </view>
        
        <view class="action-btn like-btn {{post.isLiked ? 'liked' : ''}}" bindtap="onLikePost">
          <image class="action-icon" src="{{post.isLiked ? '/images/like-active.png' : '/images/like.png'}}" mode="aspectFit" />
          <text class="action-count">{{post.likes || 0}}</text>
        </view>
      </view>

    </view>

    <!-- 评论区域 -->
    <view class="comments-container">
      
      <!-- 评论标题和排序 -->
      <view class="comments-header">
        <view class="comments-title-section">
          <text class="comments-title">评论</text>
          <text class="comments-count">({{post.comments}})</text>
        </view>
        
        <!-- 排序按钮组 -->
        <view class="sort-tabs">
          <view class="sort-tab {{sortType === 'hot' ? 'active' : ''}}" 
                data-sort="hot" 
                bindtap="onSortSelect">
            <text class="sort-tab-text">最热</text>
          </view>
          <view class="sort-tab {{sortType === 'time_desc' ? 'active' : ''}}" 
                data-sort="time_desc" 
                bindtap="onSortSelect">
            <text class="sort-tab-text">最新↑</text>
          </view>
          <view class="sort-tab {{sortType === 'time_asc' ? 'active' : ''}}" 
                data-sort="time_asc" 
                bindtap="onSortSelect">
            <text class="sort-tab-text">最早↓</text>
          </view>
        </view>
      </view>
      
      <!-- 评论列表 -->
      <view class="comments-list">
        <view wx:for="{{comments}}" wx:key="id" class="comment-item">
          <image class="comment-avatar" src="{{item.userAvatar}}" mode="aspectFill" />
          <view class="comment-main">
            <!-- 第一行：昵称和楼主标签 -->
            <view class="comment-user-info">
              <view class="comment-user-left">
                <text class="comment-username">{{item.userNickname}}</text>
                <text wx:if="{{item.isAuthor}}" class="author-tag">楼主</text>
              </view>
            </view>
            
            <!-- 第二行：评论内容 -->
            <text class="comment-content">{{item.content}}</text>
            
            <!-- 第三行：发布时间和操作按钮 -->
            <view class="comment-bottom-row">
              <text class="comment-time">{{item.timeAgo}}</text>
              <view class="comment-actions">
                <view class="comment-like-btn {{item.isLiked ? 'liked' : ''}}" 
                      bindtap="onLikeComment"
                      data-id="{{item.id}}"
                      data-index="{{index}}">
                  <image class="comment-like-icon" 
                        src="{{item.isLiked ? '/images/like-active.png' : '/images/like.png'}}" 
                        mode="aspectFit" />
                  <text class="comment-like-count" wx:if="{{item.likes > 0}}">{{item.likes}}</text>
                </view>
                <view class="comment-reply-btn" 
                      bindtap="showReplyInput"
                      data-comment="{{item}}"
                      data-index="{{index}}">
                  <text class="comment-reply-text">回复</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 加载状态 -->
        <view wx:if="{{loadingMore}}" class="loading-more">
          <text>加载中...</text>
        </view>
        
        <view wx:if="{{!hasMore && comments.length > 0}}" class="no-more-comments">
          <text>已显示全部评论</text>
        </view>
        
        <view wx:if="{{comments.length === 0 && !loadingMore}}" class="empty-comments">
          <image class="empty-comment" src="/images/comment_empty.png" mode="aspectFit" />
          <text class="empty-text">还没有评论，快来抢沙发吧~</text>
        </view>
      </view>
    </view>
    
    <!-- 底部占位，避免被输入框遮挡 -->
    <view class="bottom-placeholder"></view>
  </view>

  <!-- 底部评论输入框 -->
  <view class="comment-input-bar">
    <view class="input-wrapper">
      <!-- 文本输入框 -->
      <input class="comment-input"
            placeholder="输入消息..."
            placeholder-class="input-placeholder"
            value="{{newCommentContent}}"
            bindinput="onCommentInput"
            bindconfirm="submitComment"
            adjust-position="{{false}}"
            bindkeyboardheightchange="onKeyboardHeightChange"
            confirm-type="send"/>
      
      <!-- 发送按钮 -->
      <view class="send-btn {{newCommentContent ? 'active' : ''}}" 
            bindtap="submitComment">
        <text>发送</text>
      </view>
    </view>
  </view>
</view>