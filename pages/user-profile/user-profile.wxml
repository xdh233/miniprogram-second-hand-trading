<view class="profile-container">
  <view wx:if="{{loading}}" class="loading-wrapper">
    <view class="loading">
      <text>加载中...</text>
    </view>
  </view>

  <view wx:elif="{{error}}" class="error-wrapper">
    <view class="error">
      <text>{{error}}</text>
      <button class="retry-btn" bindtap="loadUserProfile">重试</button>
    </view>
  </view>

  <view wx:else class="profile-content">
    <view class="user-header">
      <view class="user-info">
        <view class="avatar-wrapper" bindtap="onAvatarTap">
          <image class="avatar" src="{{userInfo.avatar ? userInfo.avatar : 'https://picsum.photos/120/120?random=avatar'}}" mode="aspectFill" />
        </view>
        
        <view class="user-details">
          <view class="user-name">
            <text class="nickname">{{userInfo.nickname || userInfo.name}}</text>
            <view wx:if="{{userInfo.gender === '男'}}" class="gender male">♂</view>
            <view wx:elif="{{userInfo.gender === '女'}}" class="gender female">♀</view>
            <!-- 如果是"未设置"或其他值，不显示图标 -->
          </view>
          <text wx:if="{{userInfo.bio}}" class="user-bio">{{userInfo.bio}}</text>
          <text wx:else class="user-bio">这个人很懒，什么都没有留下~</text>
        </view>
      </view>

      <view class="action-buttons">
        <button wx:if="{{isCurrentUser}}" class="edit-btn" bindtap="editProfile">
          编辑资料
        </button>
        <button wx:else class="message-btn" bindtap="sendMessage">
          私信
        </button>
      </view>
    </view>

    <view class="content-tabs">
      <view 
        class="tab-item {{activeTab === 'posts' ? 'active' : ''}}" 
        data-tab="posts" 
        bindtap="switchTab"
      >
        动态
      </view>
      <view 
        class="tab-item {{activeTab === 'sell' ? 'active' : ''}}" 
        data-tab="sell" 
        bindtap="switchTab"
      >
        在售
      </view>
      <view 
        class="tab-item {{activeTab === 'buy' ? 'active' : ''}}" 
        data-tab="buy" 
        bindtap="switchTab"
      >
        想要
      </view>
    </view>

    <view wx:if="{{activeTab === 'posts'}}" class="posts-list">
      <view wx:if="{{userPosts.length === 0}}" class="empty-state">
        <text>还没有发布动态</text>
      </view>
      <view wx:else>
        <view 
          wx:for="{{userPosts}}" 
          wx:key="id" 
          class="post-item"
          data-post-id="{{item.id}}"
          bindtap="onPostTap"
        >
          <view class="post-header">
            <view class="post-title-wrapper">
              <text class="post-title">{{item.title}}</text>
              <text class="post-time">{{item.formattedTime}}</text>
            </view>
            <!-- 只有当前用户才能看到删除按钮 -->
            <view wx:if="{{isCurrentUser}}" class="post-actions-btn">
              <view 
                class="delete-btn" 
                data-post-id="{{item.id}}"
                catchtap="deletePost"
              >
                <image class="delete-icon" src="/images/delete.png" />
              </view>
            </view>
          </view>
          <view wx:if="{{item.content}}" class="post-content">
            {{item.content}}
          </view>
          <view wx:if="{{item.images && item.images.length > 0}}" class="post-images">
            <image 
              wx:for="{{item.images}}" 
              wx:for-item="img" 
              wx:key="*this"
              class="post-image" 
              src="{{img}}" 
              mode="aspectFill"
            />
          </view>
        </view>
      </view>
    </view>
    
    <view wx:if="{{activeTab === 'sell'}}">
      <view wx:if="{{sellItems.length > 0}}" class="items-grid">
        <view class="column left-column">
          <view 
            class="item-card" 
            wx:for="{{leftSellItems}}" 
            wx:key="id" 
            bindtap="navigateToItemDetail" 
            data-id="{{item.id}}"
          >
            <view class="item-image-container">
              <image class="item-image" src="{{item.images[0] || '/images/placeholder.png'}}" mode="aspectFill" />
              <view class="status-tag" wx:if="{{item.status !== 'selling'}}">
                <text wx:if="{{item.status === 'sold'}}">已售出</text>
                <text wx:if="{{item.status === 'withdrawn'}}">已下架</text>
              </view>
            </view>
            <view class="item-info">
              <view class="item-title">{{item.title}}</view>
              <view class="item-price">¥{{item.price}}</view>
            </view>
          </view>
        </view>

        <view class="column right-column">
          <view 
            class="item-card" 
            wx:for="{{rightSellItems}}" 
            wx:key="id" 
            bindtap="navigateToItemDetail" 
            data-id="{{item.id}}"
          >
            <view class="item-image-container">
              <image class="item-image" src="{{item.images[0] || '/images/placeholder.png'}}" mode="aspectFill" />
              <view class="status-tag" wx:if="{{item.status !== 'selling'}}">
                <text wx:if="{{item.status === 'sold'}}">已售出</text>
                <text wx:if="{{item.status === 'withdrawn'}}">已下架</text>
              </view>
            </view>
            <view class="item-info">
              <view class="item-title">{{item.title}}</view>
              <view class="item-price">¥{{item.price}}</view>
            </view>
          </view>
        </view>
      </view>
      <view wx:else class="empty-state">
        <view class="empty-text">暂无在售商品</view>
      </view>
    </view>

    <view wx:if="{{activeTab === 'buy'}}">
      <view wx:if="{{buyItems.length > 0}}" class="items-grid">
        <view class="column left-column">
          <view 
            class="item-card" 
            wx:for="{{leftBuyItems}}" 
            wx:key="id" 
            bindtap="navigateToItemDetail" 
            data-id="{{item.id}}"
          >
            <view class="item-image-container">
              <image class="item-image" src="{{item.images[0] || '/images/placeholder.png'}}" mode="aspectFill" />
              <view class="status-tag" wx:if="{{item.status !== 'seeking'}}">
                <text wx:if="{{item.status === 'bought'}}">已买到</text>
                <text wx:if="{{item.status === 'withdrawn'}}">已取消</text>
              </view>
            </view>
            <view class="item-info">
              <view class="item-title">{{item.title}}</view>
              <view class="item-price want-price">¥{{item.price}}</view>
            </view>
          </view>
        </view>

        <view class="column right-column">
          <view 
            class="item-card" 
            wx:for="{{rightBuyItems}}" 
            wx:key="id" 
            bindtap="navigateToItemDetail" 
            data-id="{{item.id}}"
          >
            <view class="item-image-container">
              <image class="item-image" src="{{item.images[0] || '/images/placeholder.png'}}" mode="aspectFill" />
              <view class="status-tag" wx:if="{{item.status !== 'seeking'}}">
                <text wx:if="{{item.status === 'bought'}}">已买到</text>
                <text wx:if="{{item.status === 'withdrawn'}}">已取消</text>
              </view>
            </view>
            <view class="item-info">
              <view class="item-title">{{item.title}}</view>
              <view class="item-price want-price">¥{{item.price}}</view>
            </view>
          </view>
        </view>
      </view>
      <view wx:else class="empty-state">
        <view class="empty-text">暂无求购信息</view>
      </view>
    </view>
  </view>
</view>