<!--item-detail.wxml-->
<view class="page-container">
  
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 商品详情内容 -->
  <scroll-view wx:else class="content-scroll" scroll-y="{{true}}" enhanced="{{true}}">
    
    <!-- 商品图片轮播 -->
    <view class="image-container">
      <swiper class="image-swiper" indicator-dots="{{false}}" autoplay="{{false}}" 
              bindchange="onImageChange">
        <swiper-item wx:for="{{item.images}}" wx:key="index">
          <image class="product-image" src="{{item}}" mode="aspectFill" 
                 bindtap="previewImage" data-src="{{item}}"></image>
        </swiper-item>
      </swiper>
      <view class="image-indicator">{{currentImageIndex + 1}}/{{item.images.length}}</view>
    </view>

    <!-- 商品信息卡片 -->
    <view class="product-card">
      <!-- 卖家信息区域 -->
      <view class="seller-section" wx:if="{{item}}" bindtap="navigateToSellerProfile">
        <image class="seller-avatar" src="{{item.sellerAvatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="seller-info">
          <text class="seller-name">{{item.sellerNickname || item.sellerName}}</text>
        </view>
        
        <!-- 状态标志 - 根据不同状态显示不同图标 -->
        <view wx:if="{{isSold}}" class="status-badge sold-badge">
          <image class="status-icon" src="/images/sold.png" mode="aspectFit"></image>
        </view>
        <view wx:elif="{{isWithdrawn}}" class="status-badge withdrawn-badge">
          <image class="status-icon" src="/images/withdrawn.png" mode="aspectFit"></image>
        </view>
      </view>

      <!-- 商品标题 -->
      <view class="product-title">{{item.title}}</view>
      
      <!-- 商品价格 -->
      <view class="product-price-section">
        <text class="product-price {{item.tradeType === 'sell' ? 'sell-price' : 'buy-price'}}">
          {{item.tradeType === 'sell' ? '售价：' : '预算：'}}¥{{item.price}}
        </text>
      </view>
      <!-- 商品描述 -->
      <view class="product-description">{{item.description}}</view>
      
      <!-- 分割线 -->
      <view class="divider"></view>
      
      <!-- 发布时间和浏览次数 -->
      <view class="product-meta">
        <text>{{item.formattedPublishTime}}</text>
        <text>浏览：{{item.viewCount}}次</text>
      </view>
    </view>

    <!-- 评论区 -->
    <view class="comments-container">
      <!-- 评论输入区域（保持原位置） -->
      <view class="comment-input-section">
        <image class="user-avatar" src="{{userInfo.avatar || '/images/default-avatar.png'}}" mode="aspectFill" />
        <view class="input-container">
          <input class="comment-input-field"
                placeholder="写评论..."
                placeholder-class="input-placeholder"
                value="{{newCommentContent}}"
                bindinput="onCommentInput"
                bindconfirm="submitComment"
                confirm-type="send"
                maxlength="200" />
          <view class="send-btn {{newCommentContent ? 'active' : ''}}" 
                bindtap="submitComment">
            <text>发送</text>
          </view>
        </view>
      </view>

      <!-- 评论标题和排序 -->
      <view class="comments-header">
        <view class="comments-title-section">
          <text class="comments-title">评论</text>
          <text class="comments-count">({{totalCommentsCount}})</text>
        </view>
        
        <!-- 排序按钮组 -->
        <view class="sort-tabs">
          <view class="sort-tab {{sortType === 'hot' ? 'active' : ''}}" 
                data-sort="hot" 
                bindtap="onSortSelect">
            <text class="sort-tab-text">最热</text>
          </view>
          <view class="sort-tab {{sortType === 'time_desc' ? 'active' : ''}}" 
                data-sort="time_desc" 
                bindtap="onSortSelect">
            <text class="sort-tab-text">最新↑</text>
          </view>
          <view class="sort-tab {{sortType === 'time_asc' ? 'active' : ''}}" 
                data-sort="time_asc" 
                bindtap="onSortSelect">
            <text class="sort-tab-text">最早↓</text>
          </view>
        </view>
      </view>
      
      <!-- 嵌套评论列表 -->
      <view class="comments-list">
        <!-- 主评论 -->
        <view wx:for="{{organizedComments}}" wx:key="id" class="comment-thread">
          
          <!-- 主评论项 -->
          <view class="comment-item main-comment">
            <image class="comment-avatar" src="{{item.userAvatar || '/images/default-avatar.png'}}" mode="aspectFill" />
            <view class="comment-main">
              <!-- 第一行：昵称+楼主标签 -->
              <view class="comment-header">
                <view class="comment-user-left">
                  <text class="comment-username" bindtap="goToUserProfile" data-user-id="{{item.userId}}">{{item.userNickname}}</text>
                  <text wx:if="{{item.isAuthor}}" class="author-tag">楼主</text>
                </view>
              </view>
              
              <!-- 第二行：评论内容 -->
              <view class="comment-content-wrapper">
                <text class="comment-content">{{item.content}}</text>
              </view>
              
              <!-- 第三行：时间 | 点赞+回复 -->
              <view class="comment-footer">
                <text class="comment-time">{{item.timeAgo}}</text>
                <view class="comment-actions">
                  <!-- 点赞按钮 -->
                  <view class="comment-like-btn {{item.isLiked ? 'liked' : ''}}" 
                        bindtap="onLikeComment"
                        data-id="{{item.id}}"
                        data-is-reply="{{false}}">
                    <image class="comment-like-icon" 
                           src="{{item.isLiked ? '/images/like-active.png' : '/images/like.png'}}" 
                           mode="aspectFit" />
                    <text class="comment-like-count" wx:if="{{item.likes > 0}}">{{item.likes}}</text>
                  </view>
                  <!-- 回复按钮 -->
                  <view class="reply-btn" bindtap="showReplyInput" 
                        data-comment="{{item}}" 
                        data-is-reply="{{false}}">
                    <text class="reply-text">回复</text>
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- 子回复列表 -->
          <view wx:if="{{item.replies && item.replies.length > 0}}" class="replies-container">
            
            <!-- 显示的回复 - 使用 displayReplies -->
            <view wx:for="{{item.displayReplies}}" 
                  wx:for-item="reply" 
                  wx:for-index="replyIndex"
                  wx:key="{{id}}"
                  class="reply-item">
              
              <view class="reply-content">
                <text class="reply-author" bindtap="goToUserProfile" data-user-id="{{reply.userId}}">{{reply.userNickname}}</text>
                <text wx:if="{{reply.isAuthor}}" class="author-tag-small">楼主</text>
                <text wx:if="{{reply.replyToUserName}}" class="reply-to">回复 @<text class="reply-target" bindtap="goToUserProfile" data-user-id="{{reply.replyToUserId}}">{{reply.replyToUserName}}</text></text>
                <text class="reply-text-content">：{{reply.content}}</text>
              </view>
              
              <view class="reply-meta">
                <text class="reply-time">{{reply.timeAgo}}</text>
                <view class="reply-actions">
                  <!-- 回复的点赞 -->
                  <view class="reply-like-btn {{reply.isLiked ? 'liked' : ''}}" 
                        bindtap="onLikeComment"
                        data-id="{{reply.id}}"
                        data-is-reply="{{true}}">
                    <image class="reply-like-icon" 
                           src="{{reply.isLiked ? '/images/like-active.png' : '/images/like.png'}}" 
                           mode="aspectFit" />
                    <text wx:if="{{reply.likes > 0}}" class="reply-like-count">{{reply.likes}}</text>
                  </view>
                  <!-- 回复按钮 -->
                  <view class="reply-reply-btn" bindtap="showReplyInput" 
                        data-comment="{{item}}" 
                        data-reply-to="{{reply}}"
                        data-is-reply="{{true}}">
                    <text>回复</text>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- 展开/收起更多回复 -->
            <view wx:if="{{item.replies.length > 2}}" class="show-more-replies">
              <view class="show-more-btn" bindtap="toggleReplies" data-index="{{index}}">
                <text wx:if="{{!item.showAllReplies}}">
                  展开更多回复 ({{item.replies.length - 2}}条)
                </text>
                <text wx:else>收起回复</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 加载状态 -->
        <view wx:if="{{loadingMore}}" class="loading-more">
          <text>加载中...</text>
        </view>
        
        <view wx:if="{{!hasMore && organizedComments.length > 0}}" class="no-more-comments">
          <text>已显示全部评论</text>
        </view>
        
        <view wx:if="{{organizedComments.length === 0 && !loadingMore}}" class="empty-comments">
          <image class="empty-comment" src="/images/comment_empty.png" mode="aspectFit" />
          <text class="empty-text">还没有评论，快来抢沙发吧~</text>
        </view>
      </view>
    </view>
    
    <!-- 底部占位，避免被操作栏遮挡 -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- 底部操作栏 -->
  <view class="bottom-actions">
    <!-- 左侧图标区域 -->
    <view class="left-actions">
      <view class="action-btn {{isLiked ? 'liked' : ''}}" bindtap="toggleLike">
        <image class="action-icon" src="{{isLiked ? '/images/like-active.png' : '/images/like.png'}}" mode="aspectFit"></image>
      </view>
      <view class="action-btn" bindtap="onShareAppMessage">
        <image class="action-icon" src="/images/share.png" mode="aspectFit"></image>
      </view>
    </view>
    
    <!-- 右侧按钮区域 -->
    <view class="right-actions">
      <!-- 购买按钮 - 只在可购买时显示 -->
      <button wx:if="{{canPurchase}}" class="buy-btn" bindtap="onBuyItem">购买</button>
      
      <!-- 已售出状态 -->
      <view wx:elif="{{isSold && item.tradeType === 'sell'}}" class="status-display sold-status">
        <text class="status-text">已售出</text>
      </view>
      
      <!-- 已下架状态 -->
      <view wx:elif="{{isWithdrawn && item.tradeType === 'sell'}}" class="status-display withdrawn-status">
        <text class="status-text">已下架</text>
      </view>
      
      <!-- 私信按钮 - 不是自己的商品且商品在售时才显示 -->
      <button wx:if="{{!isOwner && !isSold && !isWithdrawn}}" class="contact-btn" bindtap="contactSeller">私信</button>
      
      <!-- 如果是自己的商品，显示提示 -->
      <view wx:elif="{{isOwner}}" class="owner-tip">
        <text class="owner-tip-text">这是您发布的商品</text>
      </view>
      
      <!-- 商品已下架或已售出时，非卖家用户看到的提示 -->
      <view wx:elif="{{!isOwner && (isSold || isWithdrawn)}}" class="unavailable-tip">
        <text class="unavailable-text">{{isSold ? '该商品已售出' : '该商品已下架'}}</text>
      </view>
    </view>
  </view>

  <!-- 修改回复输入浮层部分 -->
  <view wx:if="{{showReplyInput}}" class="reply-input-overlay">
    <view class="overlay-bg" bindtap="cancelReply"></view>
    <view class="reply-input-panel">
      <!-- 回复提示条 -->
      <view class="reply-header">
        <text class="reply-hint">
          回复 @{{replyTargetInfo.targetName}}
          <text wx:if="{{replyTargetInfo.replyToName}}" class="reply-chain">
            (回复 @{{replyTargetInfo.replyToName}})
          </text>
        </text>
        <view class="cancel-reply" bindtap="cancelReply">
          <text>取消</text>
        </view>
      </view>
      
      <view class="input-wrapper">
        <!-- 确保以下绑定正确 -->
        <input class="reply-input"
              placeholder="写下你的回复..."
              value="{{replyContent}}"
              bindinput="onReplyInput"
              focus="{{inputFocus}}"
              confirm-type="send"/>
        
        <view class="send-btn {{replyContent ? 'active' : ''}}" 
              bindtap="submitReply">
          <text>发送</text>
        </view>
      </view>
    </view>
  </view>
</view>