<!-- pages/my-bought-items/my-bought-items.wxml -->
<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <view class="loading">
      <text>加载中...</text>
    </view>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="error-wrapper">
    <view class="error">
      <text>{{error}}</text>
      <button class="retry-btn" bindtap="loadBoughtItems">重试</button>
    </view>
  </view>

  <!-- 内容区域 -->
  <view wx:else>
    <!-- 状态筛选标签 - 四个分类 -->
    <view class="status-tabs">
      <view 
        wx:for="{{statusOptions}}" 
        wx:key="key"
        class="status-tab {{activeStatus === item.key ? 'active' : ''}}"
        data-status="{{item.key}}"
        bindtap="switchStatus"
      >
        <text class="tab-label">{{item.label}}</text>
        <text class="tab-count">({{item.count}})</text>
      </view>
    </view>

    <!-- 商品列表 -->
    <view class="items-container">
      <view wx:if="{{filteredItems.length === 0}}" class="empty-state">
        <image class="empty-icon" src="/images/empty-box.png" mode="aspectFit" />
        <text class="empty-text">暂无求购记录</text>
        <text class="empty-tip">
          {{activeStatus === 'all' ? '还没有发布过求购' : '该状态下暂无求购'}}
        </text>
      </view>

      <view wx:else class="items-list">
        <view 
          wx:for="{{filteredItems}}" 
          wx:key="id"
          class="item-card"
          data-item-id="{{item.id}}"
          bindtap="onItemTap"
        >
          <!-- 商品主要内容：左图右文布局 -->
          <view class="item-main-content">
            <!-- 左侧：商品缩略图 -->
            <view class="item-image-section">
              <image 
                class="item-thumbnail" 
                src="{{item.images && item.images[0] ? item.images[0] : '/images/placeholder.png'}}"
                mode="aspectFill"
              />
              <!-- 状态标签 -->
              <view class="status-tag {{item.status === '求购中' ? 'status-seeking' : item.status === '已买到' ? 'status-bought' : 'status-inactive'}}">
                {{item.status}}
              </view>
            </view>

            <!-- 右侧：商品信息 -->
            <view class="item-detail-section">
              <!-- 商品标题 -->
              <view class="item-title">{{item.title}}</view>
              
              <!-- 商品描述 -->
              <view class="item-description">{{item.description}}</view>
              
              <!-- 预算价格 -->
              <view class="item-price-section">
                <text class="price-label">预算：</text>
                <view class="item-price">¥{{item.price}}</view>
                <!-- 只有求购中状态才显示编辑按钮 -->
                <view 
                  wx:if="{{item.status === '求购中'}}" 
                  class="price-edit-btn"
                  data-item-id="{{item.id}}"
                  catchtap="showEditPrice"
                >
                  <image class="edit-icon" src="/images/change.png" mode="aspectFit" />
                </view>
              </view>              
              <!-- 发布时间和状态信息 -->
              <view class="item-meta">
                <text class="create-time">发布：{{item.createTime}}</text>
                <view wx:if="{{item.status === '已买到' && item.boughtTime}}" class="bought-tag">
                  <text class="bought-time">买到：{{item.boughtTime}}</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 操作按钮区域 -->
          <view class="item-actions">
            <!-- 求购中状态的按钮：标记买到、下架、删除 -->
            <block wx:if="{{item.status === '求购中'}}">
              <button 
                class="action-btn primary"
                data-item-id="{{item.id}}"
                catchtap="markAsBought"
              >
                标记买到
              </button>
              <button 
                class="action-btn secondary"
                data-item-id="{{item.id}}"
                catchtap="markAsWithdrawn"
              >
                下架
              </button>
              <button 
                class="action-btn danger"
                data-item-id="{{item.id}}"
                catchtap="deleteItem"
              >
                删除
              </button>
            </block>

            <!-- 已买到状态：显示完成信息和删除按钮 -->
            <block wx:if="{{item.status === '已买到'}}">
              <view class="bought-info">
                <!-- 根据状态类型显示不同的标志 -->
                <text wx:if="{{item.statusType === 'demand'}}" class="bought-text">求购完成</text>
                <text wx:elif="{{item.statusType === 'purchase'}}" class="bought-text">直接购买</text>
              </view>
              
              <!-- 只有求购类型的才能删除 -->
              <button 
                wx:if="{{item.statusType === 'demand'}}"
                class="action-btn danger"
                data-item-id="{{item.id}}"
                catchtap="deleteItem"
              >
                删除
              </button>
              
              <!-- 直接购买的显示购买信息 -->
              <view wx:if="{{item.statusType === 'purchase'}}" class="purchase-info">
                <text class="purchase-price">实付：¥{{item.purchasePrice}}</text>
              </view>
            </block>
            <!-- 已下架状态：重新上架和删除按钮 -->
            <block wx:if="{{item.status === '已下架'}}">
              <button 
                class="action-btn primary"
                data-item-id="{{item.id}}"
                catchtap="markAsActive"
              >
                重新上架
              </button>
              <button 
                class="action-btn danger"
                data-item-id="{{item.id}}"
                catchtap="deleteItem"
              >
                删除
              </button>
            </block>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <view wx:if="{{showPriceModal}}" class="price-modal-overlay" catchtap="hidePriceModal">
    <view class="price-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">修改预算</text>
      </view>
      
      <view class="modal-content">
        <view class="price-input-section">
          <text class="price-label">新预算</text>
          <view class="price-input-wrapper">
            <text class="currency-symbol">¥</text>
            <input 
              class="price-input"
              type="digit"
              value="{{editingPrice}}"
              placeholder="请输入预算"
              bindinput="onPriceInput"
              focus="{{showPriceModal}}"
            />
          </view>
        </view>
        
        <view class="price-tip">
          <text class="tip-text">原预算：¥{{originalPrice}}</text>
        </view>
      </view>

      <view class="modal-footer">
        <view class="modal-btn cancel-btn" bindtap="cancelPriceEdit">取消</view>
        <view class="modal-btn confirm-btn {{!editingPrice || editingPrice <= 0 ? 'disabled' : ''}}" bindtap="confirmPriceEdit">确定</view>
      </view>
    </view>
  </view>
</view>